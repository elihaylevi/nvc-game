<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Empathy VR - Stratosphere IMAX</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.3.2/dist/aframe-environment-component.min.js"></script>
</head>
<body>

    <div id="overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; text-align:center; font-family:sans-serif; padding: 20px;">
        <h1 style="font-size: 3.5rem;">The Anatomy of Emotion</h1>
        <p style="font-size: 1.5rem; color: #cbd5e1;">Stratosphere Mode: Floating at 30 meters height.</p>
        <button onclick="prepareExperience()" style="margin-top: 40px; padding:25px 60px; font-size:28px; cursor:pointer; background:#3b82f6; color:white; border:none; border-radius:50px; font-weight:bold;">INITIALIZE MISSION</button>
    </div>

    <a-scene>
        <a-assets>
            <video id="empathy-video" src="empathy.mp4" preload="auto" crossorigin="anonymous"></video>
        </a-assets>

        <a-entity id="env" environment="preset: forest; lighting: none; skyType: gradient; skyColor: #010101; horizonColor: #010101; fog: 0.98; groundColor: #000; dressingAmount: 0; ground: flat"></a-entity>
        
        <a-light type="ambient" color="#FFF" intensity="0.1"></a-light>
        <a-light type="point" position="0 35 0" intensity="1.2" color="#fbbf24" distance="40"></a-light>

        <a-camera id="main-cam" position="0 30 0" look-controls>
            <a-cursor color="#fbbf24" scale="0.6 0.6 0.6"></a-cursor>
            
            <a-entity id="nav-arrow" visible="false" position="0 -0.5 -1.2" scale="0.2 0.2 0.2">
                <a-entity id="arrow-mesh" geometry="primitive: triangle" material="color: #fbbf24; shader: flat"></a-entity>
                <a-text id="arrow-label" value="CENTER VIEW" position="0 -0.6 0" align="center" width="4" color="#fbbf24" font="exo2bold"></a-text>
            </a-entity>
            
            <a-text id="countdown-text" value="" position="0 0.5 -1.5" align="center" color="#fbbf24" width="4" font="exo2bold"></a-text>
        </a-camera>

        <a-entity position="0 30 -8"> 
            
            <a-entity position="0 3.5 0">
                <a-plane material="shader: flat; color: #000" width="12" height="2.8" opacity="0.95"></a-plane>
                <a-text id="visual-description-text" 
                        value="System Initializing at Altitude... Look forward." 
                        align="center" 
                        width="11" 
                        wrap-count="30" 
                        color="#fbbf24" 
                        font="exo2bold"
                        position="0 0 0.1"></a-text>
            </a-entity>

            <a-entity id="matrix-container" position="0 -1 0"></a-entity>
        </a-entity>

        <a-entity position="12 30 0" rotation="0 -90 0">
            <a-video src="#empathy-video" width="10" height="5.6">
                <a-entity geometry="primitive: plane; width: 10.3; height: 5.9" position="0 0 -0.05" material="color: #080808"></a-entity>
            </a-video>
            <a-text value="VIDEO FEED" position="0 3.5 0" align="center" width="10" color="#333"></a-text>
        </a-entity>

    </a-scene>

    <script>
        const video = document.querySelector('#empathy-video');
        const matrixContainer = document.querySelector('#matrix-container');
        const visualTextEl = document.querySelector('#visual-description-text');
        const countdownText = document.querySelector('#countdown-text');
        const navArrow = document.querySelector('#nav-arrow');
        const arrowMesh = document.querySelector('#arrow-mesh');
        const camera = document.querySelector('#main-cam');

        function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

        const childWords = [
            {w:"Curiosity", t:0}, {w:"Wonder", t:0}, {w:"Interest", t:0}, {w:"Attraction", t:0}, {w:"Play", t:0},
            {w:"Pain", t:0}, {w:"Fear", t:0}, {w:"Surprise", t:0}, {w:"Shock", t:0}, {w:"Hunger", t:0},
            {w:"Joy", t:0}, {w:"Belonging", t:0}, {w:"Safety", t:0}, {w:"Warmth", t:0}, {w:"Trust", t:0},
            {w:"Sadness", t:0}, {w:"Loneliness", t:0}, {w:"Longing", t:0}, {w:"Loss", t:0}, {w:"Cold", t:0},
            {w:"Love", t:0}, {w:"Hope", t:0}, {w:"Rest", t:0}, {w:"Crying", t:0}, {w:"Gaze", t:0}
        ];
        const teenWords = [
            {w:"Failure", t:1}, {w:"Guilt", t:1}, {w:"Lazy", t:1}, {w:"Shame", t:1}, {w:"Stupid", t:1},
            {w:"Hate", t:1}, {w:"Enemies", t:1}, {w:"Unfair", t:1}, {w:"Wrong", t:1}, {w:"Rebel", t:1},
            {w:"Crush", t:0}, {w:"Awkward", t:0}, {w:"Scared", t:0}, {w:"Hope", t:0}, {w:"Vulnerable", t:0},
            {w:"No-Chance", t:1}, {w:"Snob", t:1}, {w:"Fake", t:1}, {w:"Loser", t:1}, {w:"Ugly", t:1},
            {w:"Safe", t:0}, {w:"Calm", t:0}, {w:"Belong", t:0}, {w:"Angry", t:0}, {w:"Tired", t:0}
        ];
        const adultWords = [
            {w:"Imposter", t:1}, {w:"Fired", t:1}, {w:"Mistake", t:1}, {w:"Useless", t:1}, {w:"Guilty", t:1},
            {w:"Idiot", t:1}, {w:"Rude", t:1}, {w:"Victim", t:1}, {w:"Mean", t:1}, {w:"Hate", t:1},
            {w:"Alone", t:0}, {w:"Bitter", t:0}, {w:"Love", t:0}, {w:"Warmth", t:0}, {w:"Connection", t:0},
            {w:"Cynical", t:1}, {w:"Prison", t:1}, {w:"No-one understands", t:1}, {w:"Disrespect", t:1}, {w:"Failure", t:1},
            {w:"Need", t:0}, {w:"Tired", t:0}, {w:"Sad", t:0}, {w:"Fear", t:0}, {w:"Touch", t:0}
        ];

        const timeline = [
            { time: 0, action: "newPhase", words: childWords },
            { time: 0.5, action: "visual", text: "A lush green garden. A 5-year-old child crawls through the grass, spotting a flower with wonder." },
            { time: 8.04, action: "light", names: ["Curiosity", "Wonder", "Interest"], color: "#4ade80" }, 
            { time: 13.7, action: "visual", text: "A bee stings him. He recoils in shock, then bursts into tears, running to find comfort." },
            { time: 16.0, action: "light", names: ["Pain", "Fear", "Surprise", "Shock"], color: "#86efac" },
            { time: 31.16, action: "visual", text: "Silent harmony. Building a sandcastle together in shared joy." },
            { time: 34.12, action: "light", names: ["Joy", "Belonging", "Safety", "Warmth"], color: "#22c55e" },
            { time: 43.72, action: "visual", text: "The girl is called away. The child is left alone, feeling a deep longing." },
            { time: 48.4, action: "light", names: ["Sadness", "Loneliness", "Longing"], color: "#16a34a" },
            { time: 61.92, action: "newPhase", words: teenWords },
            { time: 62.5, action: "visual", text: "TRANSITION: He swings into the shadow and returns as a 14-year-old in a school hallway." },
            { time: 68.62, action: "visual", text: "He holds a test with a score of 60. The number morphs into 'You are lazy' and 'You are a disappointment'." },
            { time: 72.0, action: "light", names: ["Failure", "Guilt", "Shame", "Lazy"], color: "#ef4444" },
            { time: 79.78, action: "visual", text: "Father yells at the news: 'They are evil people'. Learning to see the world through the lens of judgment." },
            { time: 82.0, action: "light", names: ["Hate", "Enemies", "Unfair"], color: "#b91c1c" },
            { time: 94.28, action: "visual", text: "A spark of hope. She laughs, and he freezes, retreating into his hoodie." },
            { time: 96.0, action: "light", names: ["Awkward", "Scared", "Vulnerable", "Hope"], color: "#4ade80" }, 
            { time: 100.0, action: "light", names: ["No-Chance", "Loser", "Ugly"], color: "#dc2626" },
            { time: 104.76, action: "visual", text: "Laughing with a group mocking a student. Betraying his own compass just to belong." },
            { time: 113.06, action: "visual", text: "Returning home, resting his head on his mother's shoulder for a moment of sanctuary." },
            { time: 115.0, action: "light", names: ["Safe", "Calm", "Belong"], color: "#22c55e" },
            { time: 122.02, action: "newPhase", words: adultWords },
            { time: 131.32, action: "visual", text: "Email from the boss: 'Come for a talk'. He freezes in the internal courtroom of anxiety." },
            { time: 135.0, action: "light", names: ["Imposter", "Fired", "Guilty"], color: "#7f1d1d" },
            { time: 139.18, action: "visual", text: "Angry driving. He sees the dirty dishes at home as a personal attack." },
            { time: 145.0, action: "light", names: ["Idiot", "Victim", "Mean", "Cynical"], color: "#991b1b" },
            { time: 158.88, action: "visual", text: "His wife asks 'How are you?'. His eyes are soft, the lonely child peeking from within. He wants a hug." },
            { time: 160.0, action: "light", names: ["Love", "Connection", "Warmth"], color: "#22c55e" },
            { time: 165.0, action: "visual", text: "But instead says 'Everything is normal' and walks away." },
            { time: 165.5, action: "light", names: ["Alone", "Bitter", "No-one understands", "Prison"], color: "#fb923c" },
            { time: 168.0, action: "battle_final" }
        ];

        let lastTriggeredIndex = -1;
        let isRunning = false;

        function prepareExperience() {
            document.getElementById('overlay').style.display = 'none';
            let timeLeft = 10;
            requestAnimationFrame(updateNavigation);
            const countInterval = setInterval(() => {
                countdownText.setAttribute('value', `Starting in ${timeLeft}...`);
                if (timeLeft <= 0) {
                    clearInterval(countInterval);
                    countdownText.setAttribute('value', "");
                    startExperience();
                }
                timeLeft--;
            }, 1000);
        }

        function updateNavigation() {
            const rotation = camera.object3D.rotation.y * (180 / Math.PI);
            if (rotation < -40) {
                navArrow.setAttribute('visible', 'true');
                arrowMesh.setAttribute('rotation', '0 0 90');
                navArrow.setAttribute('position', '0.6 -0.5 -1.2');
            } else if (rotation > 40) {
                navArrow.setAttribute('visible', 'true');
                arrowMesh.setAttribute('rotation', '0 0 -90');
                navArrow.setAttribute('position', '-0.6 -0.5 -1.2');
            } else {
                navArrow.setAttribute('visible', 'false');
            }
            if (!isRunning || video.currentTime < video.duration) {
                requestAnimationFrame(updateNavigation);
            }
        }

        function startExperience() {
            isRunning = true;
            video.play();
            function checkSync() {
                const ct = video.currentTime;
                for (let i = 0; i < timeline.length; i++) {
                    if (ct >= timeline[i].time && i > lastTriggeredIndex) {
                        executeEvent(timeline[i]);
                        lastTriggeredIndex = i;
                    }
                }
                requestAnimationFrame(checkSync);
            }
            requestAnimationFrame(checkSync);
        }

        function executeEvent(ev) {
            if (ev.action === "newPhase") {
                buildBigShuffledGrid(ev.words);
            } else if (ev.action === "light") {
                highlightByNames(ev.names, ev.color);
            } else if (ev.action === "battle_final") {
                renderFinalBattle();
            } else if (ev.action === "visual") {
                visualTextEl.setAttribute('value', ev.text);
            }
        }

        function buildBigShuffledGrid(words) {
            matrixContainer.innerHTML = ''; 
            const shuffledWords = shuffle([...words]);
            shuffledWords.forEach((item, i) => {
                const row = Math.floor(i / 5);
                const col = i % 5;
                const slot = document.createElement('a-entity');
                slot.setAttribute('position', `${(col-2)*2.2} ${(1.6-row*0.9)} 0`); // מרווח פרימיום
                slot.dataset.word = item.w;
                const content = document.createElement('a-entity');
                content.classList.add('matrix-content');
                const box = document.createElement('a-entity');
                box.setAttribute('geometry', 'primitive: plane; width: 2; height: 0.7');
                box.setAttribute('material', {shader: 'flat', color: '#1e293b', opacity: 0.5}); 
                const textEl = document.createElement('a-text');
                textEl.setAttribute('value', item.w);
                textEl.setAttribute('align', 'center');
                textEl.setAttribute('width', '6.5'); 
                textEl.setAttribute('color', '#64748b'); 
                textEl.setAttribute('position', '0 0 0.02'); 
                textEl.setAttribute('font', 'exo2bold'); 
                content.appendChild(box);
                content.appendChild(textEl);
                slot.appendChild(content);
                matrixContainer.appendChild(slot);
            });
        }

        function highlightByNames(names, color) {
            const slots = matrixContainer.children;
            for (let slot of slots) {
                const word = slot.dataset.word;
                const content = slot.querySelector('.matrix-content');
                const box = content.querySelector('a-entity[geometry]');
                const textEl = content.querySelector('a-text');
                if (names.includes(word)) {
                    box.setAttribute('material', 'color', color);
                    box.setAttribute('material', 'opacity', 1);
                    textEl.setAttribute('color', 'white');
                    content.setAttribute('animation__pop', 'property: position.z; to: 0.8; dur: 400; easing: easeOutBack');
                } else {
                    box.setAttribute('material', 'color', '#1e293b');
                    box.setAttribute('material', 'opacity', 0.2);
                    textEl.setAttribute('color', '#475569');
                    content.setAttribute('animation__pop', 'property: position.z; to: 0; dur: 400');
                }
            }
        }

        function renderFinalBattle() {
            const slots = matrixContainer.children;
            const greenFinal = ["Alone", "Bitter"];
            const redFinal = ["Prison", "No-one understands"];
            for (let slot of slots) {
                const word = slot.dataset.word;
                const content = slot.querySelector('.matrix-content');
                const box = content.querySelector('a-entity[geometry]');
                const textEl = content.querySelector('a-text');
                if (greenFinal.includes(word)) {
                    slot.setAttribute('visible', true);
                    box.setAttribute('material', 'color', '#22c55e'); 
                    textEl.setAttribute('color', 'white');
                    content.setAttribute('position', '0 0 0.6');
                } else if (redFinal.includes(word)) {
                    slot.setAttribute('visible', true);
                    box.setAttribute('material', 'color', '#7f1d1d'); 
                    textEl.setAttribute('color', 'white');
                    content.setAttribute('scale', '1.6 1.6 1.6');
                    content.setAttribute('position', '0 0 1.2');
                } else {
                    slot.setAttribute('visible', false);
                }
            }
        }
    </script>
</body>
</html>